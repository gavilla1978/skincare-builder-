<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auntie Esty's Skincare Ingredient Decoder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /*
         * Custom styling to match the previous app's aesthetic
         */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FBF7F5; /* Light, soft pink background */
        }
        
        .decoder-card {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin: 2rem auto;
            max-width: 90%;
            border: 1px solid #F0E0D9;
        }

        .decoder-title {
            color: #C9A8A5; /* Rose color for headings */
            font-size: 2.5rem;
            font-weight: 800;
            line-height: 1.2;
        }

        .decoder-label {
            color: #4A4342;
            font-weight: 600;
        }

        .decode-btn {
            background-color: #C9A8A5;
            color: #ffffff;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .decode-btn:hover {
            background-color: #A48986;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .file-upload-btn {
            background-color: #E0D4D2;
            color: #4A4342;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .file-upload-btn:hover {
            background-color: #C9A8A5;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .result-card {
            background-color: #FBF7F5;
            border-radius: 0.75rem;
            border: 1px solid #F0E0D9;
        }
        
        .result-title {
            color: #C9A8A5;
            font-weight: 700;
        }
        
        .result-content {
            color: #333333;
        }

        .spinner {
            border-color: #E0D4D2;
            border-left-color: #C9A8A5;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 640px) {
            .decoder-title { font-size: 2rem; }
        }
    </style>
</head>
<body>
    <div id="decoder-app" class="w-full">
        <div class="decoder-card mx-auto max-w-4xl p-8 lg:p-12">
            <h1 class="decoder-title text-center font-extrabold mb-6 md:text-5xl">Skincare Ingredient Decoder</h1>
            <p class="text-center text-lg md:text-xl text-gray-600 mb-8">Paste a list of ingredients or upload an image of the list, and let's find out what they do!</p>

            <form id="ingredientForm" class="space-y-4">
                <div>
                    <label for="ingredients" class="decoder-label block mb-2">Paste your ingredients here (one per line, or comma-separated):</label>
                    <textarea id="ingredients" rows="10" class="w-full p-4 border rounded-xl focus:outline-none focus:ring-2 focus:ring-[#C9A8A5]"></textarea>
                </div>

                <div class="flex items-center justify-center">
                    <div class="w-1/2 h-px bg-[#E0D4D2]"></div>
                    <span class="mx-4 text-gray-500 text-sm">OR</span>
                    <div class="w-1/2 h-px bg-[#E0D4D2]"></div>
                </div>

                <div class="flex flex-col items-center space-y-4">
                    <label for="imageUpload" class="file-upload-btn w-full py-3 rounded-xl text-lg font-bold transition-all duration-300 ease-in-out hover:scale-105 active:scale-100 cursor-pointer text-center">
                        Upload an Image of the Ingredient List
                    </label>
                    <input type="file" id="imageUpload" accept="image/*" class="hidden">
                    <span id="fileName" class="text-sm text-gray-500"></span>
                </div>
                
                <button type="submit" id="decodeButton" class="decode-btn w-full py-3 rounded-xl text-lg font-bold transition-all duration-300 ease-in-out hover:scale-105 active:scale-100">Decode Ingredients</button>
            </form>

            <div id="loadingIndicator" class="loading-indicator flex items-center justify-center mt-8 text-[#4A4342] font-semibold text-lg hidden">
                <div class="spinner w-6 h-6 border-4 border-[#E0D4D2] border-l-[#C9A8A5] rounded-full mr-3"></div>
                <span>Auntie Esty is decoding...</span>
            </div>

            <div id="resultsContainer" class="mt-8 space-y-6 hidden">
                <!-- Decoded ingredients will be displayed here -->
            </div>

            <div id="messageBox" class="message-box rounded-xl p-4 mt-6 text-sm text-[#4A4342] hidden"></div>

            <div class="disclaimer-box rounded-xl p-4 mt-10 text-sm text-left leading-relaxed text-[#4A4342] bg-[#FBF7F5] border border-[#E0D4D2]">
                <p><strong>Auntie Esty's Wisdom:</strong> The information provided here is for general knowledge and educational purposes only. It is not a substitute for professional advice from a qualified dermatologist. Always consult a professional for a personalized assessment of your skin and product safety.</p>
            </div>
        </div>
    </div>

    <script>
        const ingredientForm = document.getElementById('ingredientForm');
        const ingredientsTextarea = document.getElementById('ingredients');
        const decodeButton = document.getElementById('decodeButton');
        const imageUpload = document.getElementById('imageUpload');
        const fileNameSpan = document.getElementById('fileName');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const resultsContainer = document.getElementById('resultsContainer');
        const messageBox = document.getElementById('messageBox');
        const decoderApp = document.getElementById('decoder-app');

        // Helper function to send the iframe height to the parent for resizing
        function sendHeightToParent() {
            if (window.parent) {
                const height = decoderApp.scrollHeight;
                window.parent.postMessage({
                    id: 'skincare-ingredient-decoder',
                    height: height
                }, '*');
            }
        }
        
        window.onload = sendHeightToParent;
        window.addEventListener('resize', sendHeightToParent);
        const observer = new MutationObserver(sendHeightToParent);
        observer.observe(document.body, { childList: true, subtree: true, attributes: true });

        // Utility function to show a temporary message
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = 'message-box rounded-xl p-4 mt-6 text-sm';
            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-700', 'border-red-300');
            } else {
                messageBox.classList.add('bg-[#FDE8D8]', 'text-[#4A4342]', 'border-[#FBC7A6]');
            }
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), 5000);
            sendHeightToParent();
        }

        // Function to render the decoded ingredients
        function renderResults(decodedIngredients) {
            resultsContainer.innerHTML = '';
            if (decodedIngredients && decodedIngredients.length > 0) {
                decodedIngredients.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'result-card p-6 shadow-sm';
                    card.innerHTML = `
                        <h3 class="result-title text-xl mb-2">${item.ingredientName}</h3>
                        <p class="result-content mb-2"><strong class="text-[#A48986]">Purpose:</strong> ${item.purpose}</p>
                        ${item.benefit ? `<p class="result-content mb-2"><strong class="text-[#A48986]">Benefits:</strong> ${item.benefit}</p>` : ''}
                        ${item.consideration ? `<p class="result-content"><strong class="text-red-600">Note:</strong> ${item.consideration}</p>` : ''}
                    `;
                    resultsContainer.appendChild(card);
                });
                resultsContainer.classList.remove('hidden');
            } else {
                showMessage("Could not decode ingredients. Please try a different list.", "error");
            }
            sendHeightToParent();
        }
        
        // Exponential backoff for API calls
        async function fetchWithExponentialBackoff(url, options, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (response.status === 429 && retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithExponentialBackoff(url, options, retries - 1, delay * 2);
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response;
            } catch (error) {
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithExponentialBackoff(url, options, retries - 1, delay * 2);
                }
                throw error;
            }
        }
        
        // Event listener for file upload to show file name
        imageUpload.addEventListener('change', () => {
            const file = imageUpload.files[0];
            if (file) {
                fileNameSpan.textContent = `File selected: ${file.name}`;
                ingredientsTextarea.value = ''; // Clear text area if image is uploaded
            } else {
                fileNameSpan.textContent = '';
            }
            sendHeightToParent();
        });


        // Main event listener for form submission
        ingredientForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const file = imageUpload.files[0];
            let ingredientsList = ingredientsTextarea.value.split(/[\n,]/).map(s => s.trim()).filter(s => s.length > 0);
            
            if (!file && ingredientsList.length === 0) {
                showMessage("Please enter at least one ingredient or upload an image.", "error");
                return;
            }

            loadingIndicator.classList.remove('hidden');
            decodeButton.disabled = true;
            resultsContainer.classList.add('hidden');
            messageBox.classList.add('hidden');
            sendHeightToParent();
            
            try {
                let finalIngredients = ingredientsList;

                if (file) {
                    loadingIndicator.querySelector('span').textContent = 'Analyzing image...';
                    const base64ImageData = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result.split(',')[1]);
                        reader.onerror = error => reject(error);
                        reader.readAsDataURL(file);
                    });

                    // Step 1: Extract text from image
                    const visionPrompt = "Extract all the text from the following image. Do not add any extra commentary or formatting.";
                    const visionPayload = {
                        contents: [{
                            role: "user",
                            parts: [
                                { text: visionPrompt },
                                {
                                    inlineData: {
                                        mimeType: file.type,
                                        data: base64ImageData
                                    }
                                }
                            ]
                        }]
                    };
                    const apiKey = "";
                    const visionApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    const visionResponse = await fetchWithExponentialBackoff(visionApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(visionPayload)
                    });
                    const visionResult = await visionResponse.json();
                    
                    if (!visionResult.candidates || visionResult.candidates.length === 0 || !visionResult.candidates[0].content || !visionResult.candidates[0].content.parts || visionResult.candidates[0].content.parts.length === 0) {
                        throw new Error('Failed to extract text from image.');
                    }
                    
                    const rawText = visionResult.candidates[0].content.parts[0].text;
                    // Sanitize and split the extracted text
                    finalIngredients = rawText.split(/[\n,]/).map(s => s.trim()).filter(s => s.length > 0);
                    
                    if (finalIngredients.length === 0) {
                        throw new Error('No ingredients could be found in the image.');
                    }
                    
                    ingredientsTextarea.value = finalIngredients.join('\n'); // Populate textarea for user
                    loadingIndicator.querySelector('span').textContent = 'Decoding ingredients...';
                }

                // Step 2: Decode ingredients (text or extracted from image)
                const decodePrompt = `For each of the following skincare ingredients, provide a brief, easy-to-understand explanation. Structure the response as a JSON array where each object has the keys 'ingredientName', 'purpose', 'benefit', and 'consideration'. Ingredients to analyze: ${finalIngredients.join(', ')}.`;

                const decodePayload = {
                    contents: [{ role: "user", parts: [{ text: decodePrompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    "ingredientName": { "type": "STRING" },
                                    "purpose": { "type": "STRING" },
                                    "benefit": { "type": "STRING" },
                                    "consideration": { "type": "STRING" }
                                },
                                "propertyOrdering": ["ingredientName", "purpose", "benefit", "consideration"]
                            }
                        }
                    }
                };

                const apiKey = "";
                const decodeApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const decodeResponse = await fetchWithExponentialBackoff(decodeApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(decodePayload)
                });
                
                const decodeResult = await decodeResponse.json();
                
                if (decodeResult.candidates && decodeResult.candidates.length > 0 &&
                    decodeResult[0].content && decodeResult[0].content.parts &&
                    decodeResult[0].content.parts.length > 0) {
                    
                    const jsonResponse = decodeResult.candidates[0].content.parts[0].text;
                    const parsedJson = JSON.parse(jsonResponse);
                    renderResults(parsedJson);
                } else {
                    throw new Error('Invalid API response structure or no candidates found.');
                }
                
            } catch (error) {
                console.error("API Call failed:", error);
                showMessage("Failed to decode ingredients. Please check the ingredient list or image and try again. Error: " + error.message, "error");
            } finally {
                loadingIndicator.classList.add('hidden');
                decodeButton.disabled = false;
                sendHeightToParent();
                imageUpload.value = ''; // Clear file input
                fileNameSpan.textContent = '';
            }
        });
    </script>
</body>
</html>


